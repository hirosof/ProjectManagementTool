# テンプレート機能 仕様書

**バージョン:** 1.0.0（仕様確定版）
**最終更新:** 2026-01-20
**ステータス:** Phase 4 で仕様確定、Phase 5 で実装予定

---

## 目次

1. [概要](#1-概要)
2. [機能概要](#2-機能概要)
3. [要件定義](#3-要件定義)
   - 3.1 [機能要件](#31-機能要件)
   - 3.2 [非機能要件](#32-非機能要件)
4. [設計方針](#4-設計方針)
5. [データ設計](#5-データ設計)
   - 5.1 [保存形式の比較](#51-保存形式の比較)
   - 5.2 [DB内テーブル設計（案A）](#52-db内テーブル設計案a)
   - 5.3 [JSON/YAML形式設計（案B）](#53-jsonyaml形式設計案b)
6. [コマンド仕様](#6-コマンド仕様)
   - 6.1 [template save](#61-template-save)
   - 6.2 [template list](#62-template-list)
   - 6.3 [template show](#63-template-show)
   - 6.4 [template apply](#64-template-apply)
   - 6.5 [template delete](#65-template-delete)
7. [処理フロー](#7-処理フロー)
   - 7.1 [テンプレート保存](#71-テンプレート保存)
   - 7.2 [テンプレート適用](#72-テンプレート適用)
8. [エラーハンドリング](#8-エラーハンドリング)
9. [制約事項](#9-制約事項)
10. [Phase 5 での実装方針](#10-phase-5-での実装方針)

---

## 1. 概要

テンプレート機能は、よく使う SubProject 構造（Task + SubTask + 依存関係）を再利用可能にする機能です。

**目的:**
- 繰り返し使用する SubProject 構造を保存し、新規プロジェクトに適用できるようにする
- プロジェクト管理の効率化（標準的なワークフローの再利用）

**スコープ:**
- **Phase 4**: 仕様確定のみ（実装は行わない）
- **Phase 5**: Textual版で実装予定

---

## 2. 機能概要

### 2.1 基本機能

| 機能 | 説明 |
|------|------|
| **テンプレート保存** | 既存の SubProject 構造をテンプレートとして保存 |
| **テンプレート一覧** | 保存済みテンプレートの一覧表示 |
| **テンプレート詳細** | テンプレートの内容（Task/SubTask構造、依存関係）を表示 |
| **テンプレート適用** | テンプレートから新規 SubProject を作成 |
| **テンプレート削除** | 不要なテンプレートを削除 |

### 2.2 ユースケース

**ユースケース1: 標準ワークフローの再利用**
- 「要件定義 → 設計 → 実装 → テスト」という標準的な開発フローをテンプレート化
- 新規プロジェクトで同じフローを簡単に作成

**ユースケース2: チーム内での共有**
- チームで使用する標準的な作業フローをテンプレート化
- メンバー間で共通のプロジェクト構造を使用

**ユースケース3: 複数プロジェクトへの展開**
- 複数の類似プロジェクトに同じ SubProject 構造を適用
- プロジェクト間での構造の統一

---

## 3. 要件定義

### 3.1 機能要件

#### FR-01: テンプレート保存

**要件:**
- SubProject 全体（Task + SubTask + 内部依存関係）をテンプレートとして保存できること
- テンプレートには名前と説明を付与できること
- 外部依存（テンプレート外のTaskへの依存）は保存しないこと（警告を表示）

**入力:**
- SubProject ID
- テンプレート名
- テンプレート説明（オプション）

**出力:**
- テンプレートID
- 保存成功メッセージ
- 外部依存に関する警告（存在する場合）

#### FR-02: テンプレート一覧

**要件:**
- 保存済みテンプレートの一覧を表示できること
- 表示項目: ID、名前、作成日時、説明

**出力:**
- テンプレート一覧（Rich Tableで表示）

#### FR-03: テンプレート詳細

**要件:**
- テンプレートの詳細（Task/SubTask構造、依存関係）を表示できること
- Task/SubTask の階層ツリー表示
- 依存関係の表示

**入力:**
- テンプレートID または テンプレート名

**出力:**
- テンプレート詳細（Rich Treeで表示）
- 依存関係一覧

#### FR-04: テンプレート適用

**要件:**
- テンプレートから新規 SubProject を作成できること
- 既存 Project に対して適用可能であること
- 適用時にステータスは UNSET に初期化されること
- 内部依存関係が再現されること
- dry-run モードで影響範囲を事前確認できること

**入力:**
- テンプレートID または テンプレート名
- 対象 Project ID
- 新規 SubProject 名（オプション、デフォルトはテンプレート名）

**出力:**
- 作成された SubProject ID
- 作成成功メッセージ

#### FR-05: テンプレート削除

**要件:**
- 不要なテンプレートを削除できること
- 削除時に確認プロンプトを表示すること

**入力:**
- テンプレートID または テンプレート名

**出力:**
- 削除成功メッセージ

### 3.2 非機能要件

#### NFR-01: パフォーマンス

- テンプレート保存: 1秒以内（通常のSubProject規模）
- テンプレート適用: 2秒以内（通常のSubProject規模）

#### NFR-02: データ整合性

- テンプレート適用時にDAG制約を維持すること
- トランザクション整合性を保つこと

#### NFR-03: 使いやすさ

- コマンドは直感的であること
- エラーメッセージは分かりやすく、対処方法を示すこと

---

## 4. 設計方針

### 4.1 基本方針

**1. SubProject テンプレート限定**
- Project全体のテンプレートは扱わない（複雑性を避けるため）
- SubProject単位でのテンプレート化に限定

**2. 外部依存禁止**
- テンプレート内部の依存関係のみ保存・再現
- 外部依存（テンプレート外のTaskへの依存）は保存しない
- 外部依存が存在する場合は警告を表示

**3. 適用時ステータスは原則 UNSET**
- テンプレート適用時、すべてのTask/SubTaskのステータスはUNSETに初期化
- 安全側の設計（ステータスを引き継がない）

**4. 適用は破壊的操作扱い**
- テンプレート適用は新規SubProjectを作成する操作
- dry-run モードを提供し、事前に影響範囲を確認可能

### 4.2 設計上の考慮事項

**1. テンプレートのバージョン管理**
- Phase 5 では未実装
- 将来的な拡張として検討（テンプレートのバージョン履歴管理）

**2. テンプレートの共有・インポート・エクスポート**
- Phase 5 では未実装
- 将来的な拡張として検討（JSON/YAML形式でのエクスポート・インポート）

**3. テンプレートの編集**
- Phase 5 では未実装
- 将来的な拡張として検討（保存済みテンプレートの編集機能）

---

## 5. データ設計

### 5.1 保存形式の比較

テンプレートの保存形式として、以下の2つの案を比較します。

**最終判断は Phase 5 冒頭で行う**ものとします。

| 項目 | 案A: DB内テーブル | 案B: JSON/YAML ファイル |
|------|-------------------|-------------------------|
| **データ整合性** | ✓ 高い（FK制約、トランザクション） | △ 低い（手動管理） |
| **クエリ柔軟性** | ✓ 高い（SQL） | △ 低い（全件読み込み） |
| **エクスポート・インポート** | △ 複雑（DB→ファイル変換が必要） | ✓ 容易（ファイルコピー） |
| **バージョン管理** | △ 難しい（マイグレーション必要） | ✓ 容易（Git等で管理） |
| **実装の複雑さ** | △ やや複雑（テーブル設計、マイグレーション） | ✓ 比較的シンプル |
| **既存DBとの統合** | ✓ シームレス | △ 別管理が必要 |

**Phase 5 での選択基準:**
- エクスポート・インポートを重視する場合: 案B（JSON/YAML）
- データ整合性・クエリ柔軟性を重視する場合: 案A（DB内テーブル）

**推奨:** 案A（DB内テーブル）
- pmtoolの既存設計（SQLiteベース）との整合性が高い
- データ整合性が保証される
- 将来的にエクスポート機能を追加可能

### 5.2 DB内テーブル設計（案A）

#### 5.2.1 テーブル定義

**templates テーブル（テンプレートマスター）:**

```sql
CREATE TABLE templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    description TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**template_tasks テーブル（テンプレート内のTask）:**

```sql
CREATE TABLE template_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id INTEGER NOT NULL,
    task_order INTEGER NOT NULL,  -- テンプレート内での順序
    name TEXT NOT NULL,
    description TEXT,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    UNIQUE (template_id, task_order)
);
```

**template_subtasks テーブル（テンプレート内のSubTask）:**

```sql
CREATE TABLE template_subtasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id INTEGER NOT NULL,
    task_order INTEGER NOT NULL,      -- 親Taskの順序
    subtask_order INTEGER NOT NULL,   -- SubTaskの順序
    name TEXT NOT NULL,
    description TEXT,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    UNIQUE (template_id, task_order, subtask_order)
);
```

**template_dependencies テーブル（テンプレート内の依存関係）:**

```sql
CREATE TABLE template_dependencies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id INTEGER NOT NULL,
    dep_type TEXT NOT NULL DEFAULT 'task',  -- 'task' or 'subtask'
    from_task_order INTEGER NOT NULL,       -- 先行Taskの順序
    to_task_order INTEGER NOT NULL,         -- 後続Taskの順序
    from_subtask_order INTEGER,             -- subtask依存の場合の先行SubTask順序
    to_subtask_order INTEGER,               -- subtask依存の場合の後続SubTask順序
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    UNIQUE (template_id, dep_type, from_task_order, to_task_order, from_subtask_order, to_subtask_order)
);
```

#### 5.2.2 設計のポイント

**1. order_index ではなく task_order/subtask_order を使用**
- テンプレート内での相対的な順序を保持
- 適用時に実際の order_index に変換

**2. FK制約で ON DELETE CASCADE**
- テンプレート削除時に関連レコードも自動削除
- データ整合性を保証

**3. UNIQUE制約**
- テンプレート内でのTask/SubTask順序の重複を防止
- 依存関係の重複を防止

### 5.3 JSON/YAML形式設計（案B）

#### 5.3.1 ファイル形式

**ファイルパス:** `data/templates/<template_name>.json`

**JSON構造例:**

```json
{
  "template": {
    "id": 1,
    "name": "開発タスク標準",
    "description": "要件定義→設計→実装→テストの標準フロー",
    "created_at": "2026-01-20T10:00:00",
    "updated_at": "2026-01-20T10:00:00",
    "tasks": [
      {
        "task_order": 1,
        "name": "要件定義",
        "description": "要件を明確にする",
        "subtasks": [
          {
            "subtask_order": 1,
            "name": "ヒアリング",
            "description": "顧客からヒアリング"
          },
          {
            "subtask_order": 2,
            "name": "要件整理",
            "description": "要件を文書化"
          }
        ]
      },
      {
        "task_order": 2,
        "name": "設計",
        "description": "システム設計を行う",
        "subtasks": [
          {
            "subtask_order": 1,
            "name": "基本設計",
            "description": "基本設計書作成"
          },
          {
            "subtask_order": 2,
            "name": "詳細設計",
            "description": "詳細設計書作成"
          }
        ]
      },
      {
        "task_order": 3,
        "name": "実装",
        "description": "コーディング",
        "subtasks": [
          {
            "subtask_order": 1,
            "name": "コーディング",
            "description": "実装"
          },
          {
            "subtask_order": 2,
            "name": "コードレビュー",
            "description": "レビュー実施"
          }
        ]
      },
      {
        "task_order": 4,
        "name": "テスト",
        "description": "テスト実施",
        "subtasks": [
          {
            "subtask_order": 1,
            "name": "単体テスト",
            "description": "ユニットテスト"
          },
          {
            "subtask_order": 2,
            "name": "結合テスト",
            "description": "統合テスト"
          }
        ]
      }
    ],
    "dependencies": [
      {
        "dep_type": "task",
        "from_task_order": 1,
        "to_task_order": 2
      },
      {
        "dep_type": "task",
        "from_task_order": 2,
        "to_task_order": 3
      },
      {
        "dep_type": "task",
        "from_task_order": 3,
        "to_task_order": 4
      }
    ]
  }
}
```

#### 5.3.2 設計のポイント

**1. 自己完結的なフォーマット**
- テンプレート1つにつき1ファイル
- すべての情報（Task/SubTask/依存関係）が1ファイルに含まれる

**2. 可読性**
- JSON形式で人間が読みやすい
- バージョン管理システム（Git）で差分確認が容易

**3. ポータビリティ**
- ファイルコピーで簡単に共有可能
- 他のpmtoolインスタンスへの移植が容易

---

## 6. コマンド仕様

### 6.1 template save

**概要:**
既存のSubProjectをテンプレートとして保存します。

**書式:**
```bash
pmtool template save subproject <subproject_id> --name <template_name> [--desc <description>]
```

**引数:**
- `<subproject_id>`: テンプレート化するSubProjectのID

**オプション:**
- `--name <template_name>`: テンプレート名（必須）
- `--desc <description>`: テンプレートの説明（オプション）

**実行例:**
```bash
# SubProject 5 を「開発タスク標準」としてテンプレート化
$ pmtool template save subproject 5 --name "開発タスク標準" --desc "要件定義→設計→実装→テストの標準フロー"
✓ Template saved: 開発タスク標準 (ID: 1)
  - 4 Tasks
  - 8 SubTasks
  - 3 dependencies (task level)

# 外部依存が存在する場合の警告
$ pmtool template save subproject 6 --name "テンプレート2"
⚠️  WARNING: External dependencies detected (not saved):
  - Task 2 → Task 10 (outside template)
✓ Template saved: テンプレート2 (ID: 2)
  - 3 Tasks
  - 6 SubTasks
  - 2 dependencies (internal only)
```

---

### 6.2 template list

**概要:**
保存済みテンプレートの一覧を表示します。

**書式:**
```bash
pmtool template list
```

**実行例:**
```bash
$ pmtool template list

Templates
┏━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ ID ┃ Name                ┃ Created             ┃ Description                           ┃
┡━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 1  │ 開発タスク標準      │ 2026-01-20 10:00:00 │ 要件定義→設計→実装→テストの標準フロー │
│ 2  │ 運用タスク標準      │ 2026-01-20 11:00:00 │ 監視→障害対応→報告の標準フロー         │
└────┴─────────────────────┴─────────────────────┴───────────────────────────────────────┘
```

---

### 6.3 template show

**概要:**
テンプレートの詳細（Task/SubTask構造、依存関係）を表示します。

**書式:**
```bash
pmtool template show <template_id_or_name>
```

**引数:**
- `<template_id_or_name>`: テンプレートID または テンプレート名

**実行例:**
```bash
$ pmtool template show "開発タスク標準"

Template: 開発タスク標準 (ID: 1)
Description: 要件定義→設計→実装→テストの標準フロー
Created: 2026-01-20 10:00:00

Structure:
📦 開発タスク標準
├── 📝 要件定義 (order: 1)
│   ├── ✏️ ヒアリング (order: 1)
│   └── ✏️ 要件整理 (order: 2)
├── 📝 設計 (order: 2)
│   ├── ✏️ 基本設計 (order: 1)
│   └── ✏️ 詳細設計 (order: 2)
├── 📝 実装 (order: 3)
│   ├── ✏️ コーディング (order: 1)
│   └── ✏️ コードレビュー (order: 2)
└── 📝 テスト (order: 4)
    ├── ✏️ 単体テスト (order: 1)
    └── ✏️ 結合テスト (order: 2)

Dependencies (Task level):
  要件定義 → 設計
  設計 → 実装
  実装 → テスト
```

---

### 6.4 template apply

**概要:**
テンプレートから新規SubProjectを作成します。

**書式:**
```bash
pmtool template apply <template_id_or_name> --to project <project_id> [--subproject-name <name>] [--dry-run]
```

**引数:**
- `<template_id_or_name>`: テンプレートID または テンプレート名

**オプション:**
- `--to project <project_id>`: 適用先のProject ID（必須）
- `--subproject-name <name>`: 新規SubProjectの名前（オプション、デフォルトはテンプレート名）
- `--dry-run`: 実行せず、影響範囲のみを表示

**実行例:**
```bash
# dry-run で影響範囲を確認
$ pmtool template apply "開発タスク標準" --to project 2 --subproject-name "機能A開発" --dry-run

[DRY RUN] Would create:
  - SubProject: 機能A開発 (in Project 2)
  - 4 Tasks: 要件定義, 設計, 実装, テスト
  - 8 SubTasks
  - 3 dependencies (task level)
  - All statuses will be UNSET

# 実際に適用
$ pmtool template apply "開発タスク標準" --to project 2 --subproject-name "機能A開発"
✓ Template applied: 開発タスク標準 → SubProject "機能A開発" (ID: 3)
  - Created 4 Tasks
  - Created 8 SubTasks
  - Created 3 dependencies
```

---

### 6.5 template delete

**概要:**
テンプレートを削除します。

**書式:**
```bash
pmtool template delete <template_id_or_name>
```

**引数:**
- `<template_id_or_name>`: テンプレートID または テンプレート名

**実行例:**
```bash
$ pmtool template delete "開発タスク標準"
⚠️  Are you sure you want to delete template "開発タスク標準"? [y/N]: y
✓ Template deleted: 開発タスク標準 (ID: 1)
```

---

## 7. 処理フロー

### 7.1 テンプレート保存

```
1. SubProject の存在確認
2. SubProject 配下の Task/SubTask を取得
3. Task/SubTask間の依存関係を取得
4. 外部依存の検出
   - 外部依存が存在する場合: 警告を表示
   - 外部依存は保存しない
5. テンプレートマスターレコード作成
6. Task/SubTask/依存関係を保存（order_index → task_order/subtask_order に変換）
7. トランザクションコミット
8. 成功メッセージ表示
```

### 7.2 テンプレート適用

```
1. テンプレートの存在確認
2. 対象 Project の存在確認
3. dry-run の場合:
   - 作成されるエンティティ数を表示
   - 処理を中断
4. 新規 SubProject を作成
5. テンプレートから Task を作成（task_order → order_index に変換）
6. テンプレートから SubTask を作成（subtask_order → order_index に変換）
7. 依存関係を再現（テンプレート内の順序 → 実際のIDに変換）
8. ステータスをすべて UNSET に設定
9. トランザクションコミット
10. 成功メッセージ表示
```

---

## 8. エラーハンドリング

### 8.1 エラーケースとメッセージ

| エラーケース | エラーメッセージ | 対処方法 |
|------------|-----------------|---------|
| SubProject が存在しない | `SubProject not found: <id>` | SubProject IDを確認 |
| Project が存在しない | `Project not found: <id>` | Project IDを確認 |
| テンプレート名が重複 | `Template name already exists: <name>` | 別の名前を使用 |
| テンプレートが存在しない | `Template not found: <id_or_name>` | テンプレート名またはIDを確認 |
| 外部依存が存在（警告） | `External dependencies detected (not saved): ...` | 警告を確認し、必要に応じて依存関係を調整 |

---

## 9. 制約事項

### 9.1 Phase 5 での制約

**1. SubProject テンプレート限定**
- Project全体のテンプレートは未対応

**2. テンプレートの編集機能なし**
- 保存済みテンプレートの編集は未対応
- 編集が必要な場合は削除→再作成

**3. テンプレートのバージョン管理なし**
- テンプレートのバージョン履歴管理は未対応

**4. エクスポート・インポート機能なし**
- JSON/YAML形式でのエクスポート・インポートは未対応
- データベース内でのみ管理

### 9.2 将来的な拡張候補

以下の機能は Phase 5 では未実装とし、将来的な拡張として検討します。

**1. Project テンプレート**
- Project全体（SubProject + Task + SubTask）のテンプレート化

**2. テンプレート編集**
- 保存済みテンプレートの編集機能
- Task/SubTaskの追加・削除・変更

**3. テンプレートのバージョン管理**
- テンプレートのバージョン履歴管理
- 過去バージョンへのロールバック

**4. エクスポート・インポート**
- JSON/YAML形式でのエクスポート
- 他のpmtoolインスタンスからのインポート

**5. テンプレートのカテゴリ分類**
- テンプレートをカテゴリで分類（開発、運用、保守など）
- カテゴリ別の一覧表示

---

## 10. Phase 5 での実装方針

### 10.1 実装順序

**ステップ1: 基本機能の実装**
1. テンプレート保存（template save）
2. テンプレート一覧（template list）
3. テンプレート詳細（template show）
4. テンプレート適用（template apply）
5. テンプレート削除（template delete）

**ステップ2: エラーハンドリング強化**
- 外部依存の検出と警告
- 適用時のバリデーション

**ステップ3: dry-run モードの実装**
- template apply --dry-run
- 影響範囲の表示

### 10.2 Textual版での統合

**Textual UIでの実装方針:**
- テンプレート管理画面の追加
- テンプレート一覧をリスト表示
- テンプレート詳細をツリー表示
- テンプレート適用時の対話的なフロー

### 10.3 保存形式の最終決定

Phase 5 冒頭で、以下の観点から保存形式を決定します。

**決定基準:**
1. エクスポート・インポートの必要性
2. 実装の複雑さ
3. 既存DBとの統合の容易さ
4. 将来的な拡張性

**推奨:** 案A（DB内テーブル）
- 既存のpmtool設計との整合性
- データ整合性の保証
- 将来的にエクスポート機能を追加可能

### 10.4 テスト方針

**ユニットテスト:**
- テンプレート保存のロジック
- テンプレート適用のロジック
- 外部依存の検出ロジック

**統合テスト:**
- テンプレート保存→適用の一連のフロー
- dry-runモードの動作確認
- エラーハンドリングの確認

**受け入れテスト:**
- 実際のユースケースでの動作確認
- Textual UIでの操作性確認

---

## まとめ

このテンプレート機能仕様書は、Phase 5 での実装のための詳細な設計書です。

**Phase 4 でのスコープ:**
- ✅ 要件定義完了
- ✅ データ設計（2案）完了
- ✅ コマンド仕様完了
- ✅ 処理フロー定義完了
- ✅ 実装方針確定

**Phase 5 でのスコープ:**
- 基本機能の実装（save, list, show, apply, delete）
- Textual UIへの統合
- テストコードの作成

**最終判断事項:**
- 保存形式（DB内テーブル vs JSON/YAML）: Phase 5 冒頭で決定

---

**変更履歴:**
- 2026-01-20: 初版作成（Phase 4 仕様確定）
